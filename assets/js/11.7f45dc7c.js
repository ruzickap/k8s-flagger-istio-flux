(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{301:function(a,e,t){a.exports=t.p+"assets/img/podinfo.f7582c4d.png"},302:function(a,e,t){a.exports=t.p+"assets/img/tekton-dashboard.7cb3a899.png"},303:function(a,e,t){a.exports=t.p+"assets/img/acr.df588aac.png"},304:function(a,e,t){a.exports=t.p+"assets/img/tmux-flux-discover-new-image.c72c6d38.png"},305:function(a,e,t){a.exports=t.p+"assets/img/tmux-canary-progress.643f78ff.png"},306:function(a,e,t){a.exports=t.p+"assets/img/grafana-canary-progress.96b2c594.png"},307:function(a,e,t){a.exports=t.p+"assets/img/tmux-canary-completed.63a82826.png"},308:function(a,e,t){a.exports=t.p+"assets/img/grafana-canary-completed.57dc8413.png"},309:function(a,e,t){a.exports=t.p+"assets/img/tmux-canary-started-to-fail.2e81f8ce.png"},310:function(a,e,t){a.exports=t.p+"assets/img/grafana-failing-canary.cb518f05.png"},311:function(a,e,t){a.exports=t.p+"assets/img/tmux-canary-failed.d6594548.png"},312:function(a,e,t){a.exports=t.p+"assets/img/grafana-canary-failed.cf1b6705.png"},326:function(a,e,t){"use strict";t.r(e);var n=t(8),s=Object(n.a)({},(function(){var a=this,e=a._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("h1",{attrs:{id:"blue-green-deployment"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#blue-green-deployment"}},[a._v("#")]),a._v(" Blue / Green deployment")]),a._v(" "),e("p",[a._v("Label the "),e("code",[a._v("default")]),a._v(" namespace with "),e("code",[a._v("istio-injection=enabled")]),a._v(":")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("kubectl label namespace default istio-injection"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("enabled\n")])])]),e("p",[a._v("Output:")]),a._v(" "),e("div",{staticClass:"language-text extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("namespace/default labeled\n")])])]),e("p",[a._v("Prepare the application manifest and save it to Git repository:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<<")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v("EOF"),e("span",{pre:!0,attrs:{class:"token bash punctuation"}},[a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" tmp/k8s-flux-repository/workloads/podinfo.yaml")]),a._v('\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: podinfo\n  namespace: default\n  labels:\n    app: podinfo\n  annotations:\n    flux.weave.works/automated: "true"\nspec:\n  minReadySeconds: 5\n  revisionHistoryLimit: 5\n  progressDeadlineSeconds: 60\n  strategy:\n    rollingUpdate:\n      maxUnavailable: 0\n    type: RollingUpdate\n  selector:\n    matchLabels:\n      app: podinfo\n  template:\n    metadata:\n      annotations:\n        prometheus.io/scrape: "true"\n      labels:\n        app: podinfo\n    spec:\n      imagePullSecrets:\n      - name: docker-config\n      containers:\n      - name: podinfod\n        image: pruzickak8smyexampledev.azurecr.io/library/podinfo:2.1.3\n        ports:\n        - containerPort: 9898\n          name: http\n          protocol: TCP\n        command:\n        - ./podinfo\n        - --port=9898\n        - --level=info\n        - --random-delay=false\n        - --random-error=false\n        env:\n        - name: PODINFO_UI_COLOR\n          value: green\n        livenessProbe:\n          exec:\n            command:\n            - podcli\n            - check\n            - http\n            - localhost:9898/healthz\n          initialDelaySeconds: 5\n          timeoutSeconds: 5\n        readinessProbe:\n          exec:\n            command:\n            - podcli\n            - check\n            - http\n            - localhost:9898/readyz\n          initialDelaySeconds: 5\n          timeoutSeconds: 5\n        resources:\n          limits:\n            cpu: 2000m\n            memory: 512Mi\n          requests:\n            cpu: 100m\n            memory: 64Mi\n---\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: podinfo-gateway\n  namespace: default\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n  - port:\n      number: 80\n      name: http-podinfo\n      protocol: HTTP\n    hosts:\n    - podinfo.'),e("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_DOMAIN}")]),a._v("\n  - port:\n      number: 443\n      name: https-podinfo\n      protocol: HTTPS\n    hosts:\n    - podinfo."),e("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_DOMAIN}")]),a._v("\n    tls:\n      credentialName: ingress-cert-"),e("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${LETSENCRYPT_ENVIRONMENT}")]),a._v("\n      mode: SIMPLE\n      privateKey: sds\n      serverCertificate: sds\n---\napiVersion: flagger.app/v1alpha3\nkind: Canary\nmetadata:\n  name: podinfo\n  namespace: default\nspec:\n  # service mesh provider (default istio)\n  # can be: kubernetes, istio, appmesh, smi, nginx, gloo, supergloo\n  # use the kubernetes provider for Blue/Green style deployments\n  provider: istio\n  # deployment reference\n  targetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: podinfo\n  # the maximum time in seconds for the canary deployment\n  # to make progress before it is rollback (default 600s)\n  progressDeadlineSeconds: 60\n  service:\n    # container port\n    port: 9898\n    # port name can be http or grpc (default http)\n    portName: http\n    # add all the other container ports\n    # when generating ClusterIP services (default false)\n    portDiscovery: false\n    # Istio gateways (optional)\n    gateways:\n    - podinfo-gateway\n      # remove the mesh gateway if the public host is\n      # shared across multiple virtual services\n    # - mesh\n    # Istio virtual service host names (optional)\n    hosts:\n    - podinfo."),e("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_DOMAIN}")]),a._v("\n  # define the canary analysis timing and KPIs\n  canaryAnalysis:\n    # schedule interval (default 60s)\n    interval: 10s\n    # max number of failed metric checks before rollback\n    threshold: 10\n    # max traffic percentage routed to canary\n    # percentage (0-100)\n    maxWeight: 50\n    # canary increment step\n    # percentage (0-100)\n    stepWeight: 5\n    # Prometheus checks\n    metrics:\n    - name: request-success-rate\n      # minimum req success rate (non 5xx responses)\n      # percentage (0-100)\n      threshold: 99\n      interval: 1m\n    - name: request-duration\n      # maximum req duration P99\n      # milliseconds\n      threshold: 500\n      interval: 30s\nEOF")]),a._v("\n")])])]),e("p",[a._v("Push the manifest file into the git repository:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" tmp/k8s-flux-repository "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--verbose")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" tmp/k8s-flux-repository commit "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Add podinfo application"')]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" tmp/k8s-flux-repository push "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-q")]),a._v("\nfluxctl "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("sync")]),a._v("\n")])])]),e("p",[a._v("Output:")]),a._v(" "),e("div",{staticClass:"language-text extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("add 'workloads/podinfo.yaml'\n[master 22f3a9c] Add podinfo application\n 1 file changed, 98 insertions(+)\n create mode 100644 workloads/podinfo.yaml\nSynchronizing with git@github.com:ruzickap/k8s-flux-repository\nRevision of master to apply is 22f3a9c\nWaiting for 22f3a9c to be applied ...\nDone.\n")])])]),e("p",[a._v("If you open the "),e("a",{attrs:{href:"http://podinfo.myexample.dev",target:"_blank",rel:"noopener noreferrer"}},[a._v("http://podinfo.myexample.dev"),e("OutboundLink")],1),a._v(" you\nshould see the following application:")]),a._v(" "),e("p",[e("img",{attrs:{src:t(301),alt:"Podinfo",title:"Podinfo"}})]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-x")]),a._v(" /usr/bin/falkon "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v(" falkon http://podinfo."),e("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_DOMAIN}")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),e("p",[a._v("The application should be ready. Verify the canary deployment details:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("kubectl describe canaries.flagger.app podinfo\n")])])]),e("p",[a._v("Output:")]),a._v(" "),e("div",{staticClass:"language-text extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('Name:         podinfo\nNamespace:    default\nLabels:       fluxcd.io/sync-gc-mark=sha256.suFcgXeCzNfy8IJ1JhXT7MbBGtOihk5WMiPqxL3zuOY\nAnnotations:  fluxcd.io/sync-checksum: 82d7e7352c7d652cb326d2510831c2d82d1c48f6\n              kubectl.kubernetes.io/last-applied-configuration:\n                {"apiVersion":"flagger.app/v1alpha3","kind":"Canary","metadata":{"annotations":{"fluxcd.io/sync-checksum":"82d7e7352c7d652cb326d2510831c2d...\nAPI Version:  flagger.app/v1alpha3\nKind:         Canary\nMetadata:\n  Creation Timestamp:  2019-09-19T06:32:30Z\n  Generation:          1\n  Resource Version:    7504\n  Self Link:           /apis/flagger.app/v1alpha3/namespaces/default/canaries/podinfo\n  UID:                 41ae5dd2-daa7-11e9-b8e0-e21b22ce44b3\nSpec:\n  Canary Analysis:\n    Interval:    10s\n    Max Weight:  50\n    Metrics:\n      Interval:               1m\n      Name:                   request-success-rate\n      Threshold:              99\n      Interval:               30s\n      Name:                   request-duration\n      Threshold:              500\n    Step Weight:              5\n    Threshold:                10\n  Progress Deadline Seconds:  60\n  Provider:                   istio\n  Service:\n    Gateways:\n      podinfo-gateway\n    Hosts:\n      podinfo.myexample.dev\n    Port:            9898\n    Port Discovery:  false\n    Port Name:       http\n  Target Ref:\n    API Version:  apps/v1\n    Kind:         Deployment\n    Name:         podinfo\nStatus:\n  Canary Weight:  0\n  Conditions:\n    Last Transition Time:  2019-09-19T06:33:07Z\n    Last Update Time:      2019-09-19T06:33:07Z\n    Message:               Deployment initialization completed.\n    Reason:                Initialized\n    Status:                True\n    Type:                  Promoted\n  Failed Checks:           0\n  Iterations:              0\n  Last Applied Spec:       3370313630240737\n  Last Transition Time:    2019-09-19T06:33:07Z\n  Phase:                   Initialized\n  Tracked Configs:\nEvents:\n  Type     Reason  Age                From     Message\n  ----     ------  ----               ----     -------\n  Warning  Synced  40s (x3 over 59s)  flagger  Halt advancement podinfo-primary.default waiting for rollout to finish: 0 of 1 updated replicas are available\n  Normal   Synced  30s                flagger  Initialization done! podinfo.default\n')])])]),e("p",[a._v("The original deployment "),e("code",[a._v("podinfo")]),a._v(" doesn't have any pods now and new deployment\n"),e("code",[a._v("podinfo-primary")]),a._v(" was created by Flagger which takes care about the traffic:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("kubectl get deployment\n")])])]),e("p",[a._v("Output:")]),a._v(" "),e("div",{staticClass:"language-text extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("NAME              READY   UP-TO-DATE   AVAILABLE   AGE\npodinfo           0/0     0            0           7m3s\npodinfo-primary   1/1     1            1           117s\n")])])]),e("p",[a._v("There are three new services created\nby Flagger - "),e("code",[a._v("podinfo-canary")]),a._v(" and "),e("code",[a._v("podinfo-primary")]),a._v(":")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("kubectl get services\n")])])]),e("p",[a._v("Output:")]),a._v(" "),e("div",{staticClass:"language-text extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("NAME              TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE\nkubernetes        ClusterIP   10.0.0.1       &lt;none>        443/TCP    43m\npodinfo           ClusterIP   10.0.4.160     &lt;none>        9898/TCP   3m38s\npodinfo-canary    ClusterIP   10.0.179.151   &lt;none>        9898/TCP   3m38s\npodinfo-primary   ClusterIP   10.0.29.128    &lt;none>        9898/TCP   3m38s\n")])])]),e("p",[a._v("There is also new "),e("code",[a._v("VirtualService")]),a._v(":")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("kubectl describe virtualservices.networking.istio.io podinfo\n")])])]),e("p",[a._v("Output:")]),a._v(" "),e("div",{staticClass:"language-text extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("Name:         podinfo\nNamespace:    default\nLabels:       &lt;none>\nAnnotations:  &lt;none>\nAPI Version:  networking.istio.io/v1alpha3\nKind:         VirtualService\nMetadata:\n  Creation Timestamp:  2019-09-19T06:32:38Z\n  Generation:          1\n  Owner References:\n    API Version:           flagger.app/v1alpha3\n    Block Owner Deletion:  true\n    Controller:            true\n    Kind:                  Canary\n    Name:                  podinfo\n    UID:                   41ae5dd2-daa7-11e9-b8e0-e21b22ce44b3\n  Resource Version:        7403\n  Self Link:               /apis/networking.istio.io/v1alpha3/namespaces/default/virtualservices/podinfo\n  UID:                     4621815f-daa7-11e9-b8e0-e21b22ce44b3\nSpec:\n  Gateways:\n    podinfo-gateway\n  Hosts:\n    podinfo.myexample.dev\n    podinfo\n  Http:\n    Route:\n      Destination:\n        Host:  podinfo-primary\n      Weight:  100\n      Destination:\n        Host:  podinfo-canary\n      Weight:  0\nEvents:        &lt;none>\n")])])]),e("p",[a._v("You can also see two new "),e("code",[a._v("DestinationRules")]),a._v(":")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("kubectl describe destinationrules.networking.istio.io\n")])])]),e("p",[a._v("Output:")]),a._v(" "),e("div",{staticClass:"language-text extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("Name:         podinfo-canary\nNamespace:    default\nLabels:       &lt;none>\nAnnotations:  &lt;none>\nAPI Version:  networking.istio.io/v1alpha3\nKind:         DestinationRule\nMetadata:\n  Creation Timestamp:  2019-09-19T06:32:37Z\n  Generation:          1\n  Owner References:\n    API Version:           flagger.app/v1alpha3\n    Block Owner Deletion:  true\n    Controller:            true\n    Kind:                  Canary\n    Name:                  podinfo\n    UID:                   41ae5dd2-daa7-11e9-b8e0-e21b22ce44b3\n  Resource Version:        7400\n  Self Link:               /apis/networking.istio.io/v1alpha3/namespaces/default/destinationrules/podinfo-canary\n  UID:                     45ed89ac-daa7-11e9-b8e0-e21b22ce44b3\nSpec:\n  Host:  podinfo-canary\nEvents:  &lt;none>\n\n\nName:         podinfo-primary\nNamespace:    default\nLabels:       &lt;none>\nAnnotations:  &lt;none>\nAPI Version:  networking.istio.io/v1alpha3\nKind:         DestinationRule\nMetadata:\n  Creation Timestamp:  2019-09-19T06:32:38Z\n  Generation:          1\n  Owner References:\n    API Version:           flagger.app/v1alpha3\n    Block Owner Deletion:  true\n    Controller:            true\n    Kind:                  Canary\n    Name:                  podinfo\n    UID:                   41ae5dd2-daa7-11e9-b8e0-e21b22ce44b3\n  Resource Version:        7401\n  Self Link:               /apis/networking.istio.io/v1alpha3/namespaces/default/destinationrules/podinfo-primary\n  UID:                     460d1352-daa7-11e9-b8e0-e21b22ce44b3\nSpec:\n  Host:  podinfo-primary\nEvents:  &lt;none>\n")])])]),e("p",[a._v("Configure Tekton pipelines to build new version of "),e("code",[a._v("podinfo")]),a._v(" application:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("sed")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-i")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"s/2.1.3/3.0.0/"')]),a._v(" tmp/k8s-flux-repository/workloads/tekton-pipelineresource.yaml\n"),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" tmp/k8s-flux-repository "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("diff")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" tmp/k8s-flux-repository "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--verbose")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" tmp/k8s-flux-repository commit "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Increase podinfo application version and build container image"')]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" tmp/k8s-flux-repository push "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-q")]),a._v("\nfluxctl "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("sync")]),a._v("\n")])])]),e("p",[a._v("Start building new image:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("sed")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-i")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"s/name: podinfo-build-docker-image-from-git-pipelinerun/name: podinfo-build-docker-image-from-git-pipelinerun-2/"')]),a._v(" tmp/k8s-flux-repository/workloads/tekton-pipelinerun.yaml\n"),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" tmp/k8s-flux-repository "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("diff")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" tmp/k8s-flux-repository "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--verbose")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" tmp/k8s-flux-repository commit "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Build new image and upload it to ACR"')]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" tmp/k8s-flux-repository push "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-q")]),a._v("\nfluxctl "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("sync")]),a._v("\n")])])]),e("p",[a._v("You can see the details about the pipeline here: "),e("a",{attrs:{href:"https://tekton-dashboard.myexample.dev/#/pipelineruns",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://tekton-dashboard.myexample.dev/#/pipelineruns"),e("OutboundLink")],1)]),a._v(" "),e("p",[e("img",{attrs:{src:t(302),alt:"Tekton Dashboard",title:"Tekton Dashboard"}})]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-x")]),a._v(" /usr/bin/falkon "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v(" falkon http://tekton-dashboard."),e("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_DOMAIN}")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),e("p",[a._v("When the build completes the new version of the "),e("code",[a._v("podinfo")]),a._v(" container image will\nappear in ACR:")]),a._v(" "),e("p",[e("img",{attrs:{src:t(303),alt:"ACR",title:"ACR"}})]),a._v(" "),e("h2",{attrs:{id:"canary-deployment"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#canary-deployment"}},[a._v("#")]),a._v(" Canary deployment")]),a._v(" "),e("p",[a._v("In few minutes the new image will be stored in ACR and Flux will automatically\ndeploy the new image (version "),e("code",[a._v("3.0.0")]),a._v(') into Kubernetes Deployment. The change\nmade by Flux into the "deployment" will be registered by Flagger and then the\ncanary deployment will start.')]),a._v(" "),e("p",[a._v("Open pages in browser:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-x")]),a._v(" /usr/bin/falkon "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  falkon "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"http://flagger-grafana.'),e("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_DOMAIN}")]),a._v('/d/flagger-istio/istio-canary?orgId=1&refresh=5s&var-namespace=default&var-primary=podinfo-primary&var-canary=podinfo"')]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("\n  falkon "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"http://grafana.'),e("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_DOMAIN}")]),a._v('/d/UbsSZTDik/istio-workload-dashboard?orgId=1&refresh=5s&var-namespace=default&var-workload=podinfo-primary&var-srcns=All&var-srcwl=All&var-dstsvc=All"')]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),e("p",[a._v("Run few commands in "),e("code",[a._v("tmux")]),a._v(":")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("tmux new-session "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsend-keys "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"\\\n  while true ; do\n  fluxctl list-images --workload default:deployment/podinfo ;\n  sleep 5 ;\n  done\n"')]),a._v(" C-m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsplit-window "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-h")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("27")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsend-keys "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"while true; do curl -s http://podinfo.'),e("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_DOMAIN}")]),a._v(' | jq .message; sleep 3; done"')]),a._v(" C-m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsplit-window "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("50")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsend-keys "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"while true; do kubectl get canary/podinfo -o json | jq .status; sleep 2; done"')]),a._v(" C-m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nselect-pane "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsplit-window "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("50")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsend-keys "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"kubectl -n istio-system logs deployment/flagger -f | jq .msg"')]),a._v(" C-m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsplit-window "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-h")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("39")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsend-keys "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"while true ; do kubectl get canaries; sleep 3; done"')]),a._v(" C-m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nset-option status off\n")])])]),e("p",[a._v("Flux discovered new version of the container image in ACR and changed\nthe deployment to use it. You should see the following on the console:")]),a._v(" "),e("p",[e("img",{attrs:{src:t(304),alt:"tmux screenshot",title:"tmux screenshot"}})]),a._v(" "),e("p",[a._v("Canary deployment in progress:")]),a._v(" "),e("p",[e("img",{attrs:{src:t(305),alt:"tmux screenshot",title:"tmux screenshot"}})]),a._v(" "),e("p",[a._v("Grafana showing the progress of canary deployment:")]),a._v(" "),e("p",[e("img",{attrs:{src:t(306),alt:"Grafana screenshot",title:"Grafana screenshot"}})]),a._v(" "),e("p",[a._v("Canary deployment successfully finished:")]),a._v(" "),e("p",[e("img",{attrs:{src:t(307),alt:"tmux screenshot",title:"tmux screenshot"}})]),a._v(" "),e("p",[a._v("Grafana graphs when canary deployment finished:")]),a._v(" "),e("p",[e("img",{attrs:{src:t(308),alt:"Grafana screenshot - Canary deployment finished",title:"Grafana screenshot - Canary deployment finished"}})]),a._v(" "),e("h2",{attrs:{id:"failed-canary-deployment"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#failed-canary-deployment"}},[a._v("#")]),a._v(" Failed Canary deployment")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("fluxctl deautomate "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--workload")]),a._v(" default:deployment/podinfo\nfluxctl release "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--workload")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("default:deployment/podinfo --update-image"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("pruzickak8smyexampledev.azurecr.io/library/podinfo:2.1.3\n")])])]),e("p",[a._v("Run the "),e("code",[a._v("tmux")]),a._v(" commands again:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("tmux new-session "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsend-keys "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"\\\n  while true ; do\n  fluxctl list-images --workload default:deployment/podinfo ;\n  sleep 5 ;\n  done\n"')]),a._v(" C-m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsplit-window "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-h")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("27")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsend-keys "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"while true; do curl -s http://podinfo.'),e("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_DOMAIN}")]),a._v(' | jq .message; sleep 3; done"')]),a._v(" C-m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsplit-window "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("50")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsend-keys "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"while true; do kubectl get canary/podinfo -o json | jq .status; sleep 2; done"')]),a._v(" C-m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nselect-pane "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsplit-window "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("50")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsend-keys "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"kubectl -n istio-system logs deployment/flagger -f | jq .msg"')]),a._v(" C-m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsplit-window "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-h")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("39")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nsend-keys "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"while true ; do kubectl get canaries; sleep 3; done"')]),a._v(" C-m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\nset-option status off\n")])])]),e("p",[a._v("Generate few HTTP 500 errors during the "),e("code",[a._v("podinfo")]),a._v(" migration to new version.\nThe migration to new version should be stopped.")]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" http://podinfo."),e("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_DOMAIN}")]),a._v("/status/500\n")])])]),e("p",[a._v("You can see that the Flagger registered the errors (generated by curl above):")]),a._v(" "),e("p",[e("img",{attrs:{src:t(309),alt:"Failing canary deployment",title:"Failing canary deployment"}})]),a._v(" "),e("p",[a._v("Failing canary deployment on Grafana dashboard:")]),a._v(" "),e("p",[e("img",{attrs:{src:t(310),alt:"Grafana - Failing canary deployment",title:"Grafana - Failing canary deployment"}})]),a._v(" "),e("p",[a._v("Canary deployment failed:")]),a._v(" "),e("p",[e("img",{attrs:{src:t(311),alt:"Canary deployment failed",title:"Canary deployment failed"}})]),a._v(" "),e("p",[a._v("Grafana dashboard after canary deployment failure:")]),a._v(" "),e("p",[e("img",{attrs:{src:t(312),alt:"Grafana - Canary deployment failed",title:"Grafana - Canary deployment failed"}})])])}),[],!1,null,null,null);e.default=s.exports}}]);